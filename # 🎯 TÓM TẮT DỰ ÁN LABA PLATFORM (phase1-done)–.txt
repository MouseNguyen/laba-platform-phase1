# üéØ T√ìM T·∫ÆT D·ª∞ √ÅN LABA PLATFORM ‚Äì PHI√äN B·∫¢N HO√ÄN CH·ªàNH (ƒê·ªÇ CHUY·ªÇN CONTEXT)

**Sao ch√©p nguy√™n vƒÉn ƒëo·∫°n n√†y ƒë·ªÉ chatbot m·ªõi hi·ªÉu ngay to√†n b·ªô ki·∫øn tr√∫c.**

---

## **1. T·ªîNG QUAN D·ª∞ √ÅN**

**T√™n**: Laba Platform  
**M·ª•c ti√™u**: X√¢y d·ª±ng n·ªÅn t·∫£ng qu·∫£n l√Ω ƒëa chi nh√°nh (Farm, Homestay, Cafe) v·ªõi booking, th∆∞∆°ng m·∫°i ƒëi·ªán t·ª≠, POS v√† CRM.  
**Ki·∫øn tr√∫c**: Plugin-based ‚Äì Phase 1 l√† core platform, c√°c Phase sau ch·ªâ th√™m module m·ªõi kh√¥ng ph√° v·ª° n·ªÅn t·∫£ng.

---

## **2. TECH STACK**

### **Backend (NestJS)**
- **Language**: TypeScript
- **Framework**: NestJS (modular architecture)
- **ORM**: Prisma
- **Database**: PostgreSQL
- **Cache/Store**: Redis (cho rate limit & lock)
- **Auth**: JWT (Access Token) + HttpOnly Cookie (Refresh Token) + Argon2id
- **Monitoring**: Prometheus + Grafana
- **Testing**: Jest (unit), k6 (load), Pact (contract)

### **Frontend (Next.js)**
- **Language**: TypeScript
- **Framework**: Next.js 14 (App Router)
- **Styling**: Tailwind CSS
- **State**: React Context (Auth)
- **HTTP Client**: Axios + Interceptor

### **Infrastructure**
- **Dev**: Docker Compose (Postgres + Redis)
- **CI/CD**: GitHub Actions (Pact verification)
- **Env**: `.env` validate b·∫±ng Joi

---

## **3. PHASE 1 ‚Äì CORE PLATFORM (‚úÖ COMPLETED)**

### **Backend ƒë√£ l√†m**
- **Module**: `auth` (login, register, refresh, logout, revoke-all, /me), `users`, `landing`, `prisma`, `security-logger`, `schedule`
- **Auth Security**:
  - Password: Argon2id (memoryCost=19456, timeCost=2)
  - Token: Access JWT ch·ª©a `sub`, `email`, `ver` (token_version)
  - Refresh: SHA-256 hash trong DB, kh√¥ng l∆∞u raw token
  - Token versioning: `user.token_version++` ‚Üí kill switch t·∫•t c·∫£ token c≈©
  - **Token reuse detection**: D√πng token ƒë√£ revoke ‚Üí log `SESSION_COMPROMISED`, revoke all, g·ª≠i webhook alert
  - Device fingerprint: IPv4/24, IPv6/64 ‚Üí ch·ªâ log WARN, kh√¥ng block
  - Rate limit: In-memory ‚Üí c·∫ßn Redis cho multi-instance
  - Account lock: Gradual lock (5 l·∫ßn sai trong 15 ph√∫t ‚Üí lock 15 ph√∫t)
- **Database Schema**:
  - `users`: `token_version`, `email_verified_at`, `failed_login_attempts`, `lock_until`, soft delete
  - `user_tokens`: `refresh_token_hash`, `device_hash`, `device_info`, `expires_at`, `revoked_at`
  - `roles`, `permissions`, `user_roles`, `role_permissions`, `user_branches`, `branches`
  - `landing_content`: Dynamic blocks (`key`, `locale`, `sort_order`, JSON content)
- **ENV**: ƒë√£ validate b·∫±ng Joi (JWT secrets, Argon2, rate limits, CORS, webhook)

### **Frontend ƒë√£ l√†m**
- **Pages**: `/` (landing), `/login`, `/dashboard` (protected)
- **Auth Flow**:
  - Access token: ch·ªâ l∆∞u trong memory
  - Refresh token: HttpOnly cookie
  - Interceptor: 401 ‚Üí refresh ‚Üí retry, 403 SESSION_COMPROMISED ‚Üí logout
- **Role Colors**: Badge xanh l√° (admin/super_admin), xanh d∆∞∆°ng, t√≠m, x√°m (staff/manager)

### **Scripts & DevOps**
- **Seed**: `prisma/seed.ts` ‚Üí admin `admin@laba.vn/Admin@123456`, branch `MAIN`, 5 landing blocks
- **Health**: `GET /health` ‚Üí check DB
- **Generate secrets**: `npm run generate-secrets`
- **Docker**: `docker-compose.dev.yml` (Postgres + Redis + Mailhog) ‚Äì **ch∆∞a t·∫°o**
- **Helmet**: `@nestjs/helmet` ch∆∞a c√†i ‚Äì **kh√¥ng blocker**

---

## **4. PHASE 1.5 ‚Äì HARDENING (‚úÖ COMPLETED)**

### **B1: Redis Multi-Instance Rate Limit ‚Äì Fail-Open**
- **Fail-open**: Redis down ‚Üí unlimited (kh√¥ng crash app)
- **Storage**: `RedisThrottlerStorage` wrap Redis error, return unlimited khi l·ªói
- **TTL**: 60s, limit 5 req/ph√∫t (login), 10 req/5 ph√∫t (refresh)
- **Guard**: `@UseGuards(ThrottlerGuard)` + `@Throttle()` decorator
- **Config**: `ENABLE_REDIS_RATE_LIMIT` (c√≥ th·ªÉ t·∫Øt trong dev)

### **B2: Rotation Lock ‚Äì Anti Race Condition**
- **TTL**: 3000ms (3 gi√¢y)
- **Fail-open**: Redis error ‚Üí v·∫´n cho ph√©p refresh
- **Implementation**: `RefreshLockService.acquireLock()` + `finally releaseLock()`
- **Behavior**: N·∫øu user spam 2 request refresh c√πng l√∫c, 1 th√†nh c√¥ng, 1 tr·∫£ 429

### **B3: Prometheus + Grafana ‚Äì Safe Metrics**
- **Metrics**: `laba_http_requests_total`, `laba_auth_events_total` (kh√¥ng c√≥ userId label)
- **Guard**: `BasicAuthGuard` b·∫£o v·ªá `/metrics`
- **Counter**: Record `LOGIN_FAIL`, `TOKEN_REUSE`, `ACCOUNT_LOCKED`
- **Docker**: `docker-compose.monitoring.yml` (Prometheus + Grafana)

### **B4: Load Test (k6) ‚Äì Realistic Scenarios**
- **Script**: `test/load/auth-flow.js` (login ‚Üí me ‚Üí loop)
- **Script**: `test/load/refresh-reuse.js` (test token reuse detection)
- **Thresholds**: `p(95)<500ms`, `login_fail<5%`

### **B5: Pact Contract Testing**
- **Consumer**: `test/pact/consumer/auth.pact.spec.ts`
- **Provider**: `test/pact/provider/auth.pact.provider.spec.ts`
- **State Handlers**: Backend t·∫°o user test khi verify
- **CI**: `.github/workflows/pact.yml`

### **B6: Silent Refresh ‚Äì Multi-Tab Deduplication (NO Web Worker)**
- **Implementation**: `setTimeout` trong `AuthContext`
- **Logic**: Refresh token tr∆∞·ªõc khi h·∫øt h·∫°n 60s
- **Deduplication**: `localStorage` lock key + `BroadcastChannel` ‚Üí ch·ªâ 1 tab refresh
- **Tab active**: Khi `document.visibilityState = visible`, n·∫øu token < 30s s·∫Øp h·∫øt ‚Üí refresh ngay

---

## **5. T√åNH TR·∫†NG HI·ªÜN T·∫†I (Production-Ready)**

### **‚úÖ ƒê√£ xong v√† ch·∫°y ƒë∆∞·ª£c**
- **Backend**: 1 instance ·ªïn ƒë·ªãnh, auth flow an to√†n, rate limit b·∫£o v·ªá
- **Frontend**: M∆∞·ª£t, dashboard protected, role badge m√†u
- **Redis**: Ch∆∞a ch·∫°y trong dev (ch·ªâ c·∫ßn khi test B1-B2)
- **Database**: PostgreSQL connection pool ƒë√£ gi·ªõi h·∫°n
-- **Helmet headers**: 
- **Docker Compose**: 

### **‚ö†Ô∏è Ch∆∞a c·∫ßn l√†m ngay**
- **Nginx/K8s Ingress**: Ch·ªâ c·∫ßn khi scale l√™n **2+ instance** (hi·ªán t·∫°i ch·∫°y 1 instance)

---

## **6. C·∫§U TR√öC TH∆Ø M·ª§C CH√çNH**

```
laba-platform-phase1/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/          # Service, controller, guard, DTO, rate limit, lock
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users/         # User module
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ landing/       # Landing API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prisma/        # Prisma service
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config/        # Joi validation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ monitoring/    # Prometheus metrics
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.ts        # Entry point
‚îÇ   ‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma  # DB schema
‚îÇ   ‚îú‚îÄ‚îÄ test/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ load/          # k6 scripts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pact/          # Pact tests
‚îÇ   ‚îî‚îÄ‚îÄ scripts/           # generate-secrets.js
‚îÇ
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app/           # Pages (/, /login, /dashboard)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ context/       # AuthContext
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lib/           # apiClient, types
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types/         # TypeScript types
‚îÇ   ‚îî‚îÄ‚îÄ next.config.js
‚îÇ
‚îú‚îÄ‚îÄ docker-compose.monitoring.yml  # Prometheus + Grafana
‚îî‚îÄ‚îÄ README.md
```

---

## **7. ENVIRONMENT VARIABLES (Backend)**

T·∫°o file `backend/.env` t·ª´ template:

```env
# Server
PORT=3000
NODE_ENV=development

# Database
DATABASE_URL="postgresql://laba_user:password@localhost:5432/laba_platform_dev?connection_limit=20"

# JWT & Cookie
JWT_ACCESS_SECRET="sinh ra b·∫±ng: npm run generate-secrets"
JWT_REFRESH_SECRET="sinh ra b·∫±ng: npm run generate-secrets"
COOKIE_SECRET="sinh ra b·∫±ng: npm run generate-secrets"

# Argon2id
ARGON2_MEMORY_COST=19456
ARGON2_TIME_COST=2
ARGON2_PARALLELISM=1

# Rate Limit
RATE_LIMIT_LOGIN_PER_USER=10
RATE_LIMIT_LOGIN_PER_IP=10
RATE_LIMIT_REGISTER_PER_IP=10

# Redis (n·∫øu test B1-B2)
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
ENABLE_REDIS_RATE_LIMIT=false  # Set true khi c·∫ßn test

# Monitoring
METRICS_USER=metrics
METRICS_PASS=changeme

# CORS
CORS_ORIGIN=http://localhost:3001

# Alert Webhook (optional)
ALERT_WEBHOOK_URL=https://hooks.slack.com/...
```

---

## **8. C√ÇU L·ªÜNH CHU·∫®N ƒê·ªÇ CH·∫†Y**

### **Backend**
```bash
cd backend

# 1. Setup
npm install
npx prisma generate
npx prisma migrate reset --force  # Ch·∫°y seed

# 2. Start Redis (n·∫øu c·∫ßn test B1-B2)
docker run -d --name redis-laba -p 6379:6379 redis:7-alpine

# 3. Start backend
npm run start:dev  # http://localhost:3000

# 4. Test auth
curl -X POST http://localhost:3000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@laba.vn","password":"Admin@123456"}'

# 5. Test health
curl http://localhost:3000/health
```

### **Frontend**
```bash
cd frontend
npm install
npm run dev  # http://localhost:3001

# Login: admin@laba.vn / Admin@123456
# V√†o /dashboard ƒë·ªÉ th·∫•y badge "SUPER ADMIN" m√†u xanh l√°
```

---

## **9. L·ªò TR√åNH Phase 2 ‚Äì BOOKING (S·∫Øp b·∫Øt ƒë·∫ßu)**

### **M·ª•c ti√™u**
Cho ph√©p kh√°ch ƒë·∫∑t ch·ªó tr·∫£i nghi·ªám (Farm tour, Homestay) v√† admin qu·∫£n l√Ω booking.

### **Backend ‚Äì C·∫ßn l√†m**
- **Module**: `booking`, `availability`
- **Tables**:
  - `booking_services`: ƒë·ªãnh nghƒ©a d·ªãch v·ª• (Farm Tour 9h-11h, max 20 kh√°ch, gi√°)
  - `bookings`: header booking (user_id, branch_id, ng√†y, tr·∫°ng th√°i, t·ªïng ti·ªÅn)
  - `booking_items`: chi ti·∫øt t·ª´ng d·ªãch v·ª• trong booking
- **APIs**:
  - `POST /api/v1/booking/public` ‚Äì t·∫°o booking (kh√¥ng c·∫ßn login)
  - `GET /api/v1/availability` ‚Äì ki·ªÉm tra slot c√≤n tr·ªëng theo ng√†y
  - `GET/POST /api/v1/booking/admin` ‚Äì qu·∫£n l√Ω (admin)
- **Logic**:
  - Transaction ƒë·ªÉ tr√°nh overbooking (double submit)
  - Check capacity theo ng√†y, gi·ªù, chi nh√°nh
  - Timezone: UTC+7 (Asia/Ho_Chi_Minh)

### **Frontend ‚Äì C·∫ßn l√†m**
- **Public page**: `/booking` ‚Äì form ch·ªçn chi nh√°nh, ng√†y, gi·ªù, s·ªë kh√°ch, lo·∫°i d·ªãch v·ª•
- **Admin page**: `/admin/bookings` ‚Äì danh s√°ch booking, filter theo ng√†y/tr·∫°ng th√°i, calendar view

---

## **10. C√ÇU H·ªéI QUAN TR·ªåNG CHO CHATBOT M·ªöI**

Khi chuy·ªÉn sang Phase 2, chatbot c·∫ßn bi·∫øt:

```
T√¥i ƒëang ·ªü Phase 1 COMPLETED, bao g·ªìm:
- Auth complete v·ªõi JWT, refresh token, Argon2id, rate limit Redis, metrics Prometheus
- Dashboard protected, role badge m√†u
- Landing page dynamic t·ª´ DB

B√¢y gi·ªù c·∫ßn b·∫Øt ƒë·∫ßu Phase 2: Booking module. H√£y t·∫°o:
1. Prisma schema cho bookings, booking_services, availability
2. NestJS module booking v·ªõi endpoints POST /booking, GET /availability
3. Logic ch·ªëng overbooking b·∫±ng transaction
4. Frontend public page form ƒë·∫∑t ch·ªó v√† admin page qu·∫£n l√Ω booking
```

**‚Üí Chatbot s·∫Ω ti·∫øp t·ª•c t·ª´ ƒë√¢y kh√¥ng c·∫ßn h·ªèi l·∫°i.**